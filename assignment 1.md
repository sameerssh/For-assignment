#!/bin/bash

# Defining variables to hold the report data

# --- Identity Info ---
HOST=$(hostname)
USER=$(whoami)
NOW=$(date +"%Y-%m-%d %H:%M:%S")

# --- System Info ---
# Geting OS Name and Version
OS_INFO=$(cat /etc/os-release | grep "PRETTY_NAME" | cut -d'=' -f2 | tr -d '"')

# Geting Uptime
UPTIME_INFO=$(uptime -p | sed 's/up //')

# Geting CPU Model Name
CPU_INFO=$(grep "model name" /proc/cpuinfo | head -n 1 | cut -d':' -f2 | sed 's/^[ \t]*//')

# Geting total RAM
RAM_INFO=$(free -h | grep "Mem" | awk '{print $2}')

# Getting Disk model and size
DISKS_INFO=$(lsblk -o MODEL,SIZE,NAME -d -e 7,11 | grep -v NAME | awk '{print $1" "$2": /dev/"$3}' | tr '\n' ' ' | sed 's/ $//')

# Getting video card info
VIDEO_INFO=$(lshw -C display 2>/dev/null | grep 'product:' | head -n 1 | awk '{for(i=2;i<=NF;++i) printf "%s ",$i}' | sed 's/ *$//')
if [ -z "$VIDEO_INFO" ]; then
    VIDEO_INFO="Not Found or Integrated Graphics"
fi

# --- Network Info ---
# Host IP Address
# Findin the interface connected to the gateway, then its IP
IFACE=$(ip r | grep default | awk '{print $5}' | head -n 1)
HOST_IP=$(ip a show $IFACE 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 | head -n 1)
if [ -z "$HOST_IP" ]; then HOST_IP="N/A"; fi

# getting the Gateway IP
GATEWAY_IP=$(ip r | grep default | awk '{print $3}' | head -n 1)
if [ -z "$GATEWAY_IP" ]; then GATEWAY_IP="N/A"; fi

#getting DNS server IP
DNS_IP=$(grep nameserver /etc/resolv.conf 2>/dev/null | awk '{print $2}' | head -n 1)
if [ -z "$DNS_IP" ]; then DNS_IP="N/A"; fi

# --- System Status ---
# logged in user
USERS=$(who | awk '{print $1}' | sort -u | tr '\n' ',' | sed 's/,$//')

# Disk Space info
# DISK_FREE=$(df -h --local --output=target,avail | tail -n +2 | awk '{printf "%s %s, ", $1, $2}' | sed 's/, $//')

# Process Count
PROCESS_COUNT=$(ps -e --no-header | wc -l)

# Load Averages (1, 5, 15 min)
LOAD_AVG=$(uptime | awk -F 'load average: ' '{print $2}' | sed 's/, /\, /g')

# Listening Network Ports
# ss -tuln gets listening TCP/UDP ports, cut off the IP part, list unique ports
PORTS=$(ss -tuln 2>/dev/null | awk 'NR>1 {print $5}' | sed 's/.*://' | sort -n | uniq | tr '\n' ',' | sed 's/,$//')

# UFW Status
UFW_STATUS=$(ufw status 2>/dev/null | head -n 1 | cut -d: -f2 | xargs)
if [ -z "$UFW_STATUS" ]; then UFW_STATUS="Not Installed/Disabled"; fi


# --- Report Output ---


echo ""
echo "System Report for ${HOST} generated by ${USER}, on ${NOW}"
echo ""

echo "System Information"
echo "------------------"
echo "OS: ${OS_INFO}"
echo "Uptime: ${UPTIME_INFO}"
echo "CPU: ${CPU_INFO}"
echo "RAM: ${RAM_INFO}"
echo "Disk(s): ${DISKS_INFO}"
echo "Video: ${VIDEO_INFO}"
echo "Host Address: ${HOST_IP}"
echo "Gateway IP: ${GATEWAY_IP}"
echo "DNS Server: ${DNS_IP}"
echo ""

echo "System Status"
echo "-------------"
echo "Users Logged In: ${USERS}"
echo "Disk Space: ${DISK_FREE}"
echo "Process Count: ${PROCESS_COUNT}"
echo "Load Averages: ${LOAD_AVG}"
echo "Listening Network Ports: ${PORTS}"
echo "UFW Status: ${UFW_STATUS}"
echo ""
